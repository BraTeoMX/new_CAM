const l=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),f=["PENDIENTE","ASIGNADO","PROCESO","ATENDIDO","FINALIZADO"],c={};function h(){f.forEach(e=>{c[e]=document.getElementById(e)})}function v(e){switch(e){case"FINALIZADO":return"bg-blue-100 text-blue-800";case"ASIGNADO":return"bg-green-100 text-green-800";case"PROCESO":return"bg-yellow-100 text-yellow-800";case"PENDIENTE":return"bg-orange-100 text-orange-800";case"ATENDIDO":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}}function p(e){const t=document.createElement("div");t.classList.add("bg-gray-200","dark:bg-gray-800","rounded-lg","shadow","p-4","cursor-move","border","border-black","text-black","w-full"),t.setAttribute("data-id",e.id);const a=v(e.Status);return t.innerHTML=`
        <div class="p-0.5">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
                Folio: ${e.Folio}
            </h5>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Módulo: ${e.Modulo}</p>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Mecánico: ${e.Mecanico}</p>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Supervisor: ${e.Supervisor}</p>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Maquina: ${e.Maquina}</p>
            <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">Problema: ${e.Problema}</p>
            <span class="inline-block px-3 py-1 text-xs font-medium rounded ${a}">${e.Status}</span>
        </div>
    `,t}function O(){Object.values(c).forEach(e=>{e.innerHTML=""})}function T(e){c[e.Status]&&c[e.Status].appendChild(p(e))}function S(){Object.values(c).forEach(e=>{Sortable.create(e,{group:"shared",animation:150,ghostClass:"bg-blue-100",onEnd:C})})}function C(e){const t=e.item,a=t.dataset.id,n=t.querySelector("h5"),o=n?n.textContent:a,r=e.to.id;if(r==="PENDIENTE"){toggleModal(!0);const i=document.getElementById("formPendiente");i.onsubmit=function(x){x.preventDefault();const u=document.getElementById("fechaPendiente").value,g=document.getElementById("motivoPendiente").value;m(a,r,u,g,()=>{M(o,u,g,()=>{toggleModal(!1)})})}}else m(a,r,null,null)}function m(e,t,a=null,n=null,o=null){const r={id:e,status:t};a&&(r.fecha=a),n&&(r.motivo=n),fetch("/update-status",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify(r)}).then(i=>i.json()).then(i=>{i.success?(fetch("/broadcast-status-ot",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({id:e,status:t})}),o&&o()):console.error("Error al actualizar la OT:",i.error)}).catch(i=>console.error("Error de red:",i))}function M(e,t,a,n=null){fetch("/events",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({title:e,start:t.split(" to ")[0],end:t.split(" to ")[1]||t,description:a})}).then(o=>o.json()).then(o=>{o.success?(console.log(`Evento registrado: ${e}.`),n&&n()):console.error("Error al guardar el evento:",o.error)}).catch(o=>console.error("Error de red al guardar evento:",o))}window.toggleModal=function(e){document.getElementById("modalPendiente").classList.toggle("hidden",!e),e&&(document.getElementById("fechaPendiente").value="",document.getElementById("motivoPendiente").value="")};let d,s,y;function k(){d=document.createElement("div"),d.id="contextMenuOT",d.className="fixed z-50 bg-white dark:bg-gray-800 border rounded shadow-lg hidden",d.innerHTML=`
        <ul>
            <li class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" id="reasignarOtOption">Re asignar OT</li>
        </ul>
    `,document.body.appendChild(d),s=document.createElement("div"),s.id="reasignarModal",s.className="fixed inset-0 z-50 hidden bg-gray-800 bg-opacity-50 flex items-center justify-center",s.innerHTML=`
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Reasignar OT</h2>
            <div id="mecanicos-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"></div>
            <div class="flex justify-end space-x-4">
                <button type="button" class="px-4 py-2 text-gray-800 dark:text-gray-300 bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 rounded-md" id="cancelReasignar">Cancelar</button>
            </div>
        </div>
    `,document.body.appendChild(s),document.addEventListener("click",()=>d.classList.add("hidden")),document.getElementById("cancelReasignar").onclick=()=>s.classList.add("hidden")}function w(e,t){e.preventDefault(),y=t,d.style.top=`${e.clientY}px`,d.style.left=`${e.clientX}px`,d.classList.remove("hidden")}function N(){fetch("/mecanicos").then(e=>e.json()).then(e=>{const t=document.getElementById("mecanicos-list");t.innerHTML="",e.forEach(a=>{const n=document.createElement("div");n.className="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 cursor-pointer hover:ring-2 hover:ring-blue-500",n.innerHTML=`
                    <p class="font-bold text-gray-900 dark:text-white">${a.nombre}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Clave: ${a.cvetra}</p>
                `,n.onclick=()=>I(y,a.cvetra,a.nombre),t.appendChild(n)}),s.classList.remove("hidden")})}function I(e,t,a){fetch("/reasignar-ot",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({id:e,num_mecanico:t,nombre:a})}).then(n=>{const o=n.headers.get("content-type");return!o||!o.includes("application/json")?n.text().then(r=>{throw new Error(r)}):n.json()}).then(n=>{if(n.success){s.classList.add("hidden");const o=document.querySelector(`[data-id="${e}"]`);if(o){const r=o.querySelector("p:nth-child(3)");r&&(r.textContent=`Mecánico: ${a}`)}}else alert("Error al reasignar: "+n.error)}).catch(n=>{alert("Error inesperado al reasignar: "+n.message),console.error(n)})}function L(){f.forEach(e=>{const t=c[e];t&&t.querySelectorAll("[data-id]").forEach(a=>{a.oncontextmenu=n=>w(n,a.dataset.id)})})}document.addEventListener("DOMContentLoaded",function(){h(),b(),E(),k(),document.getElementById("reasignarOtOption").onclick=function(e){d.classList.add("hidden"),N()}});function b(){fetch("/cardsAteOTs").then(e=>e.json()).then(e=>{O(),e.forEach(T),S(),L()}).catch(e=>{console.error("Error al cargar las OTs:",e)})}function E(){flatpickr("#fechaPendiente",{mode:"range",dateFormat:"Y-m-d",minDate:"today",defaultDate:[new Date]})}document.addEventListener("DOMContentLoaded",function(){h(),b(),E()});typeof window.Echo<"u"&&window.Echo.channel("asignaciones-ot").listen("StatusOTUpdated",e=>{const t=document.querySelector(`[data-id="${e.id}"]`);if(t){const a=p(e);t.parentNode.removeChild(t),c[e.Status]&&c[e.Status].appendChild(a)}});
