const u=document.querySelector('meta[name="csrf-token"]').getAttribute("content");document.addEventListener("DOMContentLoaded",function(){function m(){const o={SIN_ASIGNAR:document.getElementById("SIN_ASIGNAR"),PENDIENTE:document.getElementById("PENDIENTE"),PROCESO:document.getElementById("PROCESO"),ATENDIDO:document.getElementById("ATENDIDO"),FINALIZADO:document.getElementById("FINALIZADO")};Object.values(o).forEach(n=>{Sortable.create(n,{group:"shared",animation:150,ghostClass:"bg-blue-100",onEnd:a=>{const e=a.item.dataset.id,r=a.to.id;if(r==="PENDIENTE"){toggleModal(!0);const t=document.getElementById("formPendiente");t.onsubmit=function(d){d.preventDefault();const I=document.getElementById("fechaPendiente").value,E=document.getElementById("motivoPendiente").value;fetch("/update-status",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({id:e,status:r,fecha:I,motivo:E})}).then(c=>c.json()).then(c=>{c.success?(console.log(`OT ${e} actualizada correctamente.`),toggleModal(!1)):console.error("Error al actualizar la OT:",c.error)}).catch(c=>console.error("Error de red:",c))}}else fetch("/update-status",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({id:e,status:r})}).then(t=>t.json()).then(t=>{t.success?console.log(`OT ${e} actualizada a ${r}.`):console.error("Error al actualizar la OT:",t.error)}).catch(t=>console.error("Error al conectar con el servidor:",t))}})})}window.toggleModal=function(o){document.getElementById("modalPendiente").classList.toggle("hidden",!o),o&&(document.getElementById("fechaPendiente").value="",document.getElementById("motivoPendiente").value="")};function s(){fetch("/cardsAteOTs").then(o=>o.json()).then(o=>{const n={SIN_ASIGNAR:document.getElementById("SIN_ASIGNAR"),PENDIENTE:document.getElementById("PENDIENTE"),PROCESO:document.getElementById("PROCESO"),ATENDIDO:document.getElementById("ATENDIDO"),FINALIZADO:document.getElementById("FINALIZADO")};Object.values(n).forEach(a=>{a.innerHTML=""}),o.forEach(a=>{const e=document.createElement("div");switch(e.classList.add("bg-gray-200","rounded-lg","shadow","p-4","cursor-move","border","border-black","text-black","w-full"),e.setAttribute("data-id",a.id),e.innerHTML=`
                            <h3 class="text-md font-semibold">${a.Folio}</h3>
                            <p class="text-sm">${a.Descrip_prob}</p>
                        `,a.Status){case"ABIERTO":case"SIN_ASIGNAR":n.SIN_ASIGNAR.appendChild(e);break;case"PENDIENTE":n.PENDIENTE.appendChild(e);break;case"ASIGNADO":case"RE-ASIGNADO":case"PROCESO":n.PROCESO.appendChild(e);break;case"AUTONOMO":case"ATENDIDO":n.ATENDIDO.appendChild(e);break;case"FINALIZADO":n.FINALIZADO.appendChild(e);break}}),m()}).catch(o=>{console.error("Error al cargar las OTs:",o)})}s()});document.addEventListener("DOMContentLoaded",function(){function m(){const s={SIN_ASIGNAR:document.getElementById("SIN_ASIGNAR"),PENDIENTE:document.getElementById("PENDIENTE"),PROCESO:document.getElementById("PROCESO"),ATENDIDO:document.getElementById("ATENDIDO"),FINALIZADO:document.getElementById("FINALIZADO")};Object.values(s).forEach(o=>{Sortable.create(o,{group:"shared",animation:150,ghostClass:"bg-blue-100",onEnd:n=>{const a=n.item,e=a.dataset.id,r=a.querySelector("h3").textContent,t=n.to.id;if(t==="PENDIENTE"){toggleModal(!0);const d=document.getElementById("formPendiente");d.onsubmit=function(I){I.preventDefault();const E=document.getElementById("fechaPendiente").value,c=document.getElementById("motivoPendiente").value;fetch("/update-status",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({id:e,status:t})}).then(l=>l.json()).then(l=>{l.success?(console.log(`OT ${r} actualizada a ${t}.`),fetch("/events",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({title:r,start:E.split(" to ")[0],end:E.split(" to ")[1]||E,description:c})}).then(i=>i.json()).then(i=>{i.success?(console.log(`Evento registrado: ${r}.`),toggleModal(!1)):console.error("Error al guardar el evento:",i.error)}).catch(i=>console.error("Error de red al guardar evento:",i))):console.error("Error al actualizar el estado de la OT:",l.error)}).catch(l=>console.error("Error de red al actualizar estado:",l))}}else fetch("/update-status",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u},body:JSON.stringify({id:e,status:t})}).then(d=>d.json()).then(d=>{d.success?console.log(`OT ${r} actualizada a ${t}.`):console.error("Error al actualizar el estado de la OT:",d.error)}).catch(d=>console.error("Error de red al actualizar estado:",d))}})})}window.toggleModal=function(s){document.getElementById("modalPendiente").classList.toggle("hidden",!s),s&&(document.getElementById("fechaPendiente").value="",document.getElementById("motivoPendiente").value="")},flatpickr("#fechaPendiente",{mode:"range",dateFormat:"Y-m-d"}),m()});
