const l=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),h=["SIN_ASIGNAR","PENDIENTE","ASIGNADO","PROCESO","ATENDIDO","FINALIZADO"],c={};function p(){h.forEach(e=>{c[e]=document.getElementById(e)})}function v(e){switch(e){case"SIN_ASIGNAR":return"bg-gray-300 text-gray-800";case"FINALIZADO":return"bg-blue-800 text-blue-100";case"ASIGNADO":return"bg-blue-100 text-blue-800";case"PROCESO":return"bg-yellow-100 text-yellow-800";case"PENDIENTE":return"bg-red-100 text-red-800";case"ATENDIDO":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}}function y(e){const t=document.createElement("div");t.classList.add("bg-gray-200","dark:bg-gray-800","rounded-lg","shadow","p-4","cursor-move","border","border-black","text-black","w-full"),t.setAttribute("data-id",e.id);const n=v(e.Status);return t.innerHTML=`
        <div class="p-0.5">
            <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
                Folio: ${e.Folio}
            </h5>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Módulo: ${e.Modulo}</p>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Mecánico: ${e.Mecanico}</p>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Supervisor: ${e.Supervisor}</p>
            <p class="mb-1 font-semibold text-gray-700 dark:text-gray-400">Maquina: ${e.Maquina}</p>
            <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">Problema: ${e.Problema}</p>
            <span class="inline-block px-3 py-1 text-xs font-medium rounded ${n}">${e.Status}</span>
        </div>
    `,t}function S(){Object.values(c).forEach(e=>{e.innerHTML=""})}function O(e){c[e.Status]&&c[e.Status].appendChild(y(e))}function T(){Object.entries(c).forEach(([e,t])=>{t&&Sortable.create(t,{group:e==="SIN_ASIGNAR"?{name:"shared",put:!1}:"shared",animation:150,ghostClass:"bg-blue-100",onEnd:C})})}function C(e){const t=e.item,n=t.dataset.id,o=t.querySelector("h5"),r=o?o.textContent:n,a=e.to.id;if(a==="PENDIENTE"){toggleModal(!0);const d=document.getElementById("formPendiente");d.onsubmit=function(u){u.preventDefault();const g=document.getElementById("fechaPendiente").value,m=document.getElementById("motivoPendiente").value;f(n,a,g,m,()=>{N(r,g,m,()=>{toggleModal(!1)})})}}else f(n,a,null,null)}function f(e,t,n=null,o=null,r=null){const a={id:e,status:t};n&&(a.fecha=n),o&&(a.motivo=o),fetch("/update-status",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify(a)}).then(d=>d.json()).then(d=>{d.success?(fetch("/broadcast-status-ot",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({id:e,status:t})}),r&&r()):console.error("Error al actualizar la OT:",d.error)}).catch(d=>console.error("Error de red:",d))}function N(e,t,n,o=null){fetch("/events",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({title:e,start:t.split(" to ")[0],end:t.split(" to ")[1]||t,description:n})}).then(r=>r.json()).then(r=>{r.success?(console.log(`Evento registrado: ${e}.`),o&&o()):console.error("Error al guardar el evento:",r.error)}).catch(r=>console.error("Error de red al guardar evento:",r))}window.toggleModal=function(e){document.getElementById("modalPendiente").classList.toggle("hidden",!e),e&&(document.getElementById("fechaPendiente").value="",document.getElementById("motivoPendiente").value="")};let i,s,b;function w(){i=document.createElement("div"),i.id="contextMenuOT",i.className="fixed z-50 bg-white dark:bg-gray-800 border rounded shadow-lg hidden",i.innerHTML=`
        <ul>
            <li class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" id="reasignarOtOption">Re asignar OT</li>
        </ul>
    `,document.body.appendChild(i),s=document.createElement("div"),s.id="reasignarModal",s.className="fixed inset-0 z-50 hidden bg-gray-800 bg-opacity-50 flex items-center justify-center",s.innerHTML=`
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Reasignar OT</h2>
            <div id="mecanicos-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"></div>
            <div class="flex justify-end space-x-4">
                <button type="button" class="px-4 py-2 text-white dark:text-white bg-red-500 dark:bg-red-500 hover:bg-red-300 rounded-md" id="cancelReasignar">Cancelar</button>
            </div>
        </div>
    `,document.body.appendChild(s),document.addEventListener("click",()=>i.classList.add("hidden")),document.getElementById("cancelReasignar").onclick=()=>s.classList.add("hidden")}function I(e,t){e.preventDefault(),b=t,i.style.top=`${e.clientY}px`,i.style.left=`${e.clientX}px`,i.classList.remove("hidden")}function k(){fetch("/mecanicos").then(e=>e.json()).then(e=>{const t=document.getElementById("mecanicos-list");t.innerHTML="",e.forEach(n=>{const o=`http://128.150.102.45:8000/Intimark/${n.cvetra}.jpg`,r=document.createElement("div");r.className="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 cursor-pointer hover:ring-2 hover:ring-blue-500 flex items-center gap-4",r.innerHTML=`
                    <img class="w-10 h-10 rounded-full cursor-pointer"
                        src="${o}"
                        alt="${n.cvetra} image"
                        id="user-img-${n.cvetra}"
                        onerror="this.onerror=null; this.src='/default-avatar.jpg';">
                    <div>
                        <p class="font-bold text-gray-900 dark:text-white">${n.nombre}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Clave: ${n.cvetra}</p>
                    </div>
                `,r.onclick=()=>M(b,n.cvetra,n.nombre),t.appendChild(r)}),s.classList.remove("hidden")})}function M(e,t,n){const o=document.querySelector(`[data-id="${e}"]`);let r=null;if(o){const a=o.querySelector("span");a&&(r=a.textContent.trim())}fetch("/reasignar-ot",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({id:e,num_mecanico:t,nombre:n,status:r})}).then(a=>{const d=a.headers.get("content-type");return!d||!d.includes("application/json")?a.text().then(u=>{throw new Error(u)}):a.json()}).then(a=>{if(a.success){if(s.classList.add("hidden"),o){const d=o.querySelector("p:nth-child(3)");d&&(d.textContent=`Mecánico: ${n}`)}}else alert("Error al reasignar: "+a.error)}).catch(a=>{alert("Error inesperado al reasignar: "+a.message),console.error(a)})}function A(){h.forEach(e=>{const t=c[e];t&&t.querySelectorAll("[data-id]").forEach(n=>{n.oncontextmenu=o=>I(o,n.dataset.id)})})}document.addEventListener("DOMContentLoaded",function(){p(),E(),x(),w(),document.getElementById("reasignarOtOption").onclick=function(e){i.classList.add("hidden"),k()}});function E(){fetch("/cardsAteOTs").then(e=>e.json()).then(e=>{S(),e.forEach(O),T(),A()}).catch(e=>{console.error("Error al cargar las OTs:",e)})}function x(){flatpickr("#fechaPendiente",{mode:"range",dateFormat:"Y-m-d",minDate:"today",defaultDate:[new Date]})}document.addEventListener("DOMContentLoaded",function(){p(),E(),x()});typeof window.Echo<"u"&&window.Echo.channel("asignaciones-ot").listen("StatusOTUpdated",e=>{const t=document.querySelector(`[data-id="${e.id}"]`);if(t){const n=y(e);t.parentNode.removeChild(t),c[e.Status]&&c[e.Status].appendChild(n)}});
